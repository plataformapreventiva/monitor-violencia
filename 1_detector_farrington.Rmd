---
title: "Prototipo para alertas de homicidio"
output: html_notebook
bibliography: bibliography.bib
nocite: |
    @Yang2018, @surveillance, 
---

```{r, message=FALSE, warning = FALSE}
library(tidyverse)
library(lubridate)
library(surveillance)
```

# Datos

Fuente de datos: https://elcri.men/es/datos.html, del Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública.

```{r, eval=TRUE, message=FALSE, warning=FALSE}
nm <- read_csv("./data/nm-fuero-comun-municipios.csv", progress = FALSE)
nm <- nm %>% mutate(date = ymd(paste0(date, '-01')))
tipo_homidicio <- c("FEMINICIDIO", "HOMICIDIO")
homicidios <- nm %>% filter(tipo %in% tipo_homidicio) %>%
    select(state_code, state, mun_code, municipio, date, count, population) %>% 
    group_by(state_code, state, mun_code, municipio, date) %>% 
    summarise(population = first(population), count = sum(count))
```


# Métodos de monitoreo: bayesiano simple

Consideramos modelos que se utilizan en epidemiología.

Referencia: https://cran.r-project.org/web/packages/surveillance/vignettes/surveillance.pdf

En particular, consideramos el método bayesiano de la referencia anterior:

```{r}
data(k1)
plot(k1)
# Evaluar de 27 a 192
k1_surveil <- algo.bayes(k1,
  control = list(range = 27:192, b = 0, w = 6, alpha = 0.01))
plot(k1_surveil)
```

Para aplicar este método, primero definimos:

- Valores de referencia para estimar parámetros del modelo, que son
las observaciones pasadas de conteos de homicidios $y_i$. 
- Región donde queremos crear predicciones, límites superiores, y detectar
anomalías.

Una vez definido, el modelo para nuevas observaciones (ver referencia) $y_k$ es

- $P(y_k | \lambda)$ es Poisson con parmátro lambda
- $\lambda$ es Gamma con parámetros $(\alpha, \beta)$.

La posterior para $\lambda$ es Gamma con parámetros
$(\alpha + \sum_i y_i, \beta + n)$, y la posterior predictiva
es Poisson-Gamma con los mismos parámetros.

Una vez que calculamos la posterior predictiva, establecemos una
alarma si la observación $y_k$ satisface $y_k > y_\alpha$, 
donde $y_\alpha$ es el cuantil $1- \alpha$ de la posterior predictiva.

En los ejemplos siguientes, pondremos 

- $\alpha = 0.02$
- Observaciones de 6 meses anteriores para estimar parámetros, solo
del año corriente.

# Ejemplos, método bayesiano

Consideramos tres municipios de Puebla:

```{r}
#puebla_edo <- filter(homicidios, state == "PUEBLA")
puebla_edo <- readRDS("data/puebla.rds")
puebla_edo %>% group_by(municipio) %>% summarise(count = sum(count)) %>% 
    arrange(desc(count)) %>% 
    filter(municipio %in% c("PUEBLA", "CHILCHOTLA", "HUAUCHINANGO"))
```

```{r}
huauchinango <- puebla_edo %>% filter(state == "PUEBLA", municipio == "HUAUCHINANGO")
puebla <- puebla_edo %>% filter(state == "PUEBLA", municipio == "PUEBLA")
chilchotla <- puebla_edo %>% filter(state =="PUEBLA", municipio == "CHILCHOTLA")
```


```{r}
source("./deteccion-homicidios.R")
```

```{r, warning = FALSE}
monitor_huau <- monitor_bayes(huauchinango)
graf_monitor(monitor_huau)
```

```{r}
monitor_huau$data %>% tail
```



```{r, warning = FALSE}
monitor_huau <- monitor_bayes(huauchinango, alpha = 0.005)
graf_monitor(monitor_huau)
```


```{r, warning = FALSE}
monitor_pue <- monitor_bayes(puebla)
graf_monitor(monitor_pue)
```


```{r, warning = FALSE}
monitor_chi <- monitor_bayes(chilchotla)
graf_monitor(monitor_chi)
```


# Métodos de monitoreo: Farrington

En la referencia del [paquete surveillance](https://www.jstatsoft.org/article/view/v070i10) se implementan
otros métodos:

- CDC y otros: utilizan media, varianza y utilizan una aproximación normal
simple.
- Farrington y variaciones: similar al modelo bayesiano, pero con un modelo
para la media que puede incluir tendencia y estacionalidad. Es el método que
se utiliza por agencias europeas de monitoreo.

Consideramos el método de Farrington (mejorado, ), es utiliza un modelo lineal generalizado
Poisson

1. Supongamos que los valores de referencia son $y_t$
2. Se ajusta un modelo Poisson sobredisperso a los datos de referencia,
con
$$E(y_t) = \mu_t, Var(y_t) = \phi \mu_t,$$
donde $\phi$ es el parámetro de sobredispersión, y donde
$$\log(\mu_k) = \alpha + \beta t$$ 
sirve para modelar tendencia.

3. Se calculan pesos para los datos, reduciendo el peso de *outliers* según
la distribución obtenida de los datos de referencia.

4. Se reajusta el modelo con los pesos calculados en el paso anterior

5. Para el paso de detección, usamos el método de Noufaily (2012) (ver referencia
de paquete), donde la distribución de referencia para el nuevo valor $y_{t_0}$
es
$$y_{t_0}\sim NB(\mu_{t_0}, \eta)$$ 
donde $\eta= \frac{\mu_{t_0}}{\phi - 1}$.

Notas: 

- Este enfoque ignora la incertidumbre en la estimación de los parámetros
$\mu_{t_0}$ y $\phi$.
- Para declarar una anomalía, se requieren también al menos 5 casos en los últimos 3 meses (incluyendo el mes que se está evaluando).

6. Utilizamos 4 meses alrededor de del valor que queremos predecir, considerando
dos años atrás (para un total de 2 + 2(4) + 1 = 11 datos de referencia).


```{r, warning = FALSE}
monitor_huau <- monitor_farrington(huauchinango, alpha=0.05, periods = 1)
graf_monitor(monitor_huau)
```


```{r}
monitor_huau$data %>%  tail
```


```{r, warning = FALSE}
monitor_puebla <- monitor_farrington(puebla, periods = 10)
```



```{r, warning = FALSE}
monitor_chi <- monitor_farrington(chilchotla, alpha = 0.02, periods = 10)
graf_monitor(monitor_chi)
```






# Otros ejemplos

```{r}
#sinaloa_edo <- filter(homicidios, state == "SINALOA")
sinaloa_edo <- readRDS("data/sinaloa.rds")
sinaloa_edo %>% group_by(municipio) %>% summarise(count = sum(count)) %>% 
    arrange(desc(count)) 
```

```{r, warning = FALSE, fig.keep=FALSE}
dat_sinaloa <- sinaloa_edo %>% split(.$municipio) 
monitores_sinaloa <- 
    lapply(dat_sinaloa, function(df){
        monitor_mun <- monitor_farrington(df, alpha = 0.02, periods = 5)
        g <- graf_monitor(monitor_mun)
        g
    })
```

```{r, fig.width = 6, fig.height = 10, warning = FALSE}
library(gridExtra)
marrangeGrob(monitores_sinaloa, nrow = 6, ncol = 3)
```

```{r}
mex_edo <- filter(homicidios, state == "MICHOACÁN")
#sinaloa_edo <- readRDS("data/sinaloa.rds")
mex_edo %>% group_by(municipio) %>% summarise(count = sum(count)) %>% 
    arrange(desc(count)) 
```

```{r, warning = FALSE, fig.width = 6, fig.height = 10}
dat_mex <- mex_edo %>% split(.$municipio) 
monitores_mex <- 
    lapply(dat_mex, function(df){
        monitor_mun <- monitor_farrington(df, alpha = 0.02, periods = 5)
        g <- graf_monitor(monitor_mun)
        list(graf = g, monitor = monitor_mun)
    })
```

```{r}
tiene_alerta <- function(monitor){
    any(monitor$monitor$data$alerta == 1)
}
monitores_alarma <- keep(monitores_mex, tiene_alerta)
```

```{r, fig.width = 6, fig.height = 10}
graficas <- monitores_alarma %>% map(~.$graf)
marrangeGrob(graficas, nrow = 4, ncol = 3)
```



```{r}
mex_edo <- filter(homicidios, state == "VERACRUZ")
#sinaloa_edo <- readRDS("data/sinaloa.rds")
mex_edo %>% group_by(municipio) %>% summarise(count = sum(count)) %>% 
    arrange(desc(count)) 
```

```{r, warning = FALSE, fig.width = 6, fig.height = 10}
dat_mex <- mex_edo %>% split(.$municipio) 
monitores_mex <- 
    lapply(dat_mex, function(df){
        monitor_mun <- monitor_farrington(df, alpha = 0.02, periods = 5)
        g <- graf_monitor(monitor_mun)
        list(graf = g, monitor = monitor_mun)
    })
```

```{r}
tiene_alerta <- function(monitor){
    any(monitor$monitor$data$alerta == 1)
}
monitores_alarma <- keep(monitores_mex, tiene_alerta)
```

```{r, fig.width = 6, fig.height = 10}
graficas <- monitores_alarma %>% map(~.$graf)
marrangeGrob(graficas, nrow = 4, ncol = 3)
```


# Ejemplo: alertas de septiembre

```{r}
dat_nal <- homicidios %>% split(list(.$municipio, .$state), drop = TRUE) 
length(dat_nal)

monitores_nal <- 
    lapply(dat_nal, function(df){
        # farrington por default, a menos que haya menos de 2 años de datos
        # o no converja.
        monitor_mun <- monitor(df, alpha = 0.05, periods = 1)
        #g <- graf_monitor(monitor_mun)
        #list(graf = g, monitor = monitor_mun)
        monitor_mun
    })
tipos <- sapply(monitores_nal, function(monitor){ monitor$tipo })
table(tipos)
```

Alertas
```{r}
alertas <- sapply(monitores_nal, function(monitor){ 
    any(monitor$data$alerta, na.rm = TRUE) }
    )
table(alertas)
alertas_mun <- which(alertas)
alertas_mun
```


```{r, warning = FALSE}
for(i in 1:length(alertas_mun)){
    print(graf_monitor(monitores_nal[[alertas_mun[i]]]))
}
```

# References


