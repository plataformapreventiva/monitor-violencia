---
title: "Prototipo para alertas de homicidio"
output: html_notebook
---

```{r, message=FALSE, warning = FALSE}
library(tidyverse)
library(lubridate)
```

# Datos

Fuente de datos: https://elcri.men/es/datos.html, del Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública.

```{r, eval=FALSE}
nm <- read_csv("./data/nm-fuero-comun-municipios.csv")
nm <- nm %>% mutate(date = ymd(paste0(date, '-01')))
tipo_homidicio <- c("FEMINICIDIO", "HOMICIDIO")
homicidios <- nm %>% filter(tipo %in% tipo_homidicio) %>%
    select(state_code, state, mun_code, municipio, date, count, population) %>% 
    group_by(state_code, state, mun_code, municipio, date) %>% 
    summarise(population = first(population), count = sum(count))
```


# Métodos de monitoreo

Consideramos modelos que se utilizan en epidemiología.

Referencia: https://cran.r-project.org/web/packages/surveillance/vignettes/surveillance.pdf

En particular, consideramos el método bayesiano de la referencia anterior:

```{r}
library(surveillance)
data(k1)
plot(k1)
# Evaluar de 27 a 192
k1_surveil <- algo.bayes(k1,
  control = list(range = 27:192, b = 0, w = 6, alpha = 0.01))
plot(k1_surveil)
```

Para aplicar este método, primero definimos:

- Valores de referencia para estimar parámetros del modelo, que son
las observaciones pasadas de conteos de homicidios $y_i$. 
- Región donde queremos crear predicciones, límites superiores, y detectar
anomalías.

Una vez definido, el modelo para nuevas observaciones (ver referencia) $y_k$ es

- $P(y_k | \lambda)$ es Poisson con parmátro lambda
- $\lambda$ es Gamma con parámetros $(\alpha, \beta)$.

La posterior para $\lambda$ es Gamma con parámetros
$(\alpha + \sum_i y_i, \beta + n)$, y la posterior predictiva
es Poisson-Gamma con los mismos parámetros.

Una vez que calculamos la posterior predictiva, establecemos una
alarma si la observación $y_k$ satisface $y_k > y_\alpha$, 
donde $y_\alpha$ es el cuantil $1- \alpha$ de la posterior predictiva.

En los ejemplos siguientes, pondremos 

- $\alpha = 0.02$
- Observaciones de 6 meses anteriores para estimar parámetros, solo
del año corriente.

# Ejemplos, método bayesiano

Consideramos tres municipios de Puebla:

```{r}
#puebla_edo <- filter(homicidios, state == "PUEBLA")
puebla_edo <- readRDS("data/puebla.rds")
puebla_edo %>% group_by(municipio) %>% summarise(count = sum(count)) %>% 
    arrange(desc(count)) %>% 
    filter(municipio %in% c("PUEBLA", "CHILCHOTLA", "HUAUCHINANGO"))
```

```{r}
huauchinango <- puebla_edo %>% filter(state == "PUEBLA", municipio == "HUAUCHINANGO")
puebla <- puebla_edo %>% filter(state == "PUEBLA", municipio == "PUEBLA")
chilchotla <- puebla_edo %>% filter(state =="PUEBLA", municipio == "CHILCHOTLA")
```


```{r}
source("./deteccion-homicidios.R")
```

```{r, warning = FALSE}
monitor_huau <- monitor(huauchinango)
graf_monitor(monitor_huau)
```

```{r, warning = FALSE}
monitor_huau <- monitor(huauchinango, alpha = 0.005)
graf_monitor(monitor_huau)
```


```{r, warning = FALSE}
monitor_pue <- monitor(puebla)
graf_monitor(monitor_pue)
```


```{r, warning = FALSE}
monitor_chi <- monitor(chilchotla)
graf_monitor(monitor_chi)
```
