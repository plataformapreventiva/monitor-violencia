---
title: "Modelos para la implementación de monitoreo de homicidios"
author: "Felipe González"
date: Diciembre, 2018
output: 
    pdf_document:
        toc: true
        number_sections: true
        toc_depth: 2
    html_document:
        toc: true
        toc_depth: 2
        number_sections: true
bibliography: bibliography.bib
nocite: |
    @Yang2018, @surveillance, @SESNSP, @DValle, @envipe
---

# Introducción

En este documento mostramos fundamentos y ejemplos de implementación de un sistema
de monitoreo de violencia en México basado en los datos de homicidios a nivel municipal
provistos
por el Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública ([@SESNSP]).

**El objetivo es producir un detector de anomalías (datos inusualmente altos en incidencia)
de los datos reportados, con el fin de enfocar el análisis a acciones
a municipios de interés**.
Esos municipios de interés deberán ser identificados por reportes inusualmente
altos de incidencia de homicidio, en contraste a aquellos municipios donde los
datos reportados tengan variación consistente con la que se ha observado históricamente.

Aunque el interés general es medición de violencia, la decisión de utilizar 
solamente los datos de homicidios (homicidios más feminicidios según la nueva 
metodología de la SESNSP) se debe a que otros tipos de crímenes violentos
tienden a tener niveles altos de cifra negra -- alrededor de 90\% o más según
la [Encuesta de Victimización del INEGI](https://www.inegi.org.mx/programas/envipe/2018/),
mientras que esto sucede en mucho menor grado con homicidios. Otras indicadores
de crimen con cifra negra relativamente baja son el robo de automóvil, por ejemplo,
pero consideramos que este no necesariamente refleja el interés en medir la violencia
que experimenta la población en cada municipio.


# Datos
 
 Usamos los datos de homicidios y feminicidios a nivel municipal provistos
por el Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública ([@SESNSP]).
Estos datos son publicados cada mes.

Otra fuente de este tipo de datos son los reportados por INEGI, que se consideran
más completos y precisos. Los datos de INEGI, sin embargo, son publicados con
retraso de un año, lo que los descalifica para un sistema de monitoreo que pretende
evaluar la situación actual de los municipios. 

```{r, message=FALSE, warning = FALSE}
library(tidyverse)
library(lubridate)
library(surveillance)
```

El archivo de datos que utilizamos es preprocesado de los datos crudos
según el código de [https://github.com/diegovalle/new.crimenmexico](https://github.com/diegovalle/new.crimenmexico),
a partir de los datos del Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública.

```{r, eval=TRUE, message=FALSE, warning=FALSE}
nm <- read_csv("./data/nm-fuero-comun-municipios.csv", progress = FALSE)
nm <- nm %>% mutate(date = ymd(paste0(date, '-01')))
tipo_homidicio <- c("FEMINICIDIO", "HOMICIDIO")
homicidios <- nm %>% filter(tipo %in% tipo_homidicio) %>%
    select(state_code, state, mun_code, municipio, date, count, population) %>% 
    group_by(state_code, state, mun_code, municipio, date) %>% 
    summarise(population = first(population), count = sum(count))
```

# Metodología

Consideramos que el enfoque apropiado para constuir monitores de violencia
es el adoptado en la epidemiología para detección de brotes de enfermedades
infecciosas ([@farrington]). La detección temprana de estos brotes en
una aspecto importante de sistemas de monitoreo epidemiológicos, y están
implementados en muchos países [@farrington] con el fin de proveerlos de
respuesta epidemiológica oportuna.

Existen varias aproximaciones para los construcción de estos sistemas
de detección temprana. Por ejemplo:

- CDC y otros: utilizan media, varianza y utilizan una aproximación normal
simple. Algunos modelos simples bayesianos son similares a este método.
- Agencias europeas de monitoreo: método de 
Farrington y variaciones. Similar al modelo bayesiano, pero con un modelo
para la media que puede incluir tendencia y estacionalidad. 


En este documento, examinaremos algunos de
los que más ampliamente implementados, como algunos métodos bayesianos y
el método de Farrington 
[@surveillance2]. Utilizamos las implementaciones 
del paquete de R [surveillance](https://cran.r-project.org/web/packages/surveillance/vignettes/surveillance.pdf).

# Métodos de monitoreo: bayesiano simple

Uno de los métodos más simples, de desempeño competitivo ([@Yang2018]) utiliza
un enfoque parcialmente bayesiano construido a partir de una regresión Poisson
con sobredispersión. Este es un ejemplo típico utilizado en la detección de
brotes de *Kryptosporidiose* en Alemania [@surveillance]:

```{r}
data(k1)
plot(k1)
# Evaluar de 27 a 192
k1_surveil <- algo.bayes(k1,
  control = list(range = 27:192, b = 0, w = 6, alpha = 0.01))
plot(k1_surveil)
```

Para aplicar este método, primero definimos:

- Valores de referencia para estimar parámetros del modelo, que son
las observaciones pasadas de conteos de homicidios $y_i$. 
- Región donde queremos crear predicciones, límites superiores, y detectar
anomalías.

Una vez definida la ventana de valores de referencia y horizonte de
predicción, el modelo para nuevas observaciones (ver referencia) $y_k$ es

- $P(y_k | \lambda)$ es Poisson con parmátro lambda
- $\lambda$ es Gamma con parámetros $(\alpha, \beta)$.

De forma que la posterior para $\lambda$ es Gamma con parámetros
$(\alpha + \sum_i y_i, \beta + n)$, y la posterior predictiva
es Poisson-Gamma con los mismos parámetros.

Una vez que calculamos la posterior predictiva, establecemos una
alarma si la observación $y_k$ satisface $y_k > y_\alpha$, 
donde $y_\alpha$ es el cuantil $1- \alpha$ de la posterior predictiva.

En los ejemplos siguientes, pondremos 

- $\alpha = 0.02$
- Observaciones de 6 meses anteriores para estimar parámetros, solo
del año corriente.

### Ejemplos: método bayesiano.

Consideramos tres municipios de Puebla:

```{r}
#puebla_edo <- filter(homicidios, state == "PUEBLA")
puebla_edo <- readRDS("data/puebla.rds")
puebla_edo %>% group_by(municipio) %>% summarise(count = sum(count)) %>% 
    arrange(desc(count)) %>% 
    filter(municipio %in% c("PUEBLA", "CHILCHOTLA", "HUAUCHINANGO"))
```

```{r}
huauchinango <- puebla_edo %>% filter(state == "PUEBLA", municipio == "HUAUCHINANGO")
puebla <- puebla_edo %>% filter(state == "PUEBLA", municipio == "PUEBLA")
chilchotla <- puebla_edo %>% filter(state =="PUEBLA", municipio == "CHILCHOTLA")
```


```{r}
source("./deteccion-homicidios.R")
```

```{r, warning = FALSE}
monitor_huau <- monitor_bayes(huauchinango, alpha = 0.05)
graf_monitor(monitor_huau)
```

```{r}
monitor_huau$data %>% tail
```






```{r, warning = FALSE}
monitor_pue <- monitor_bayes(puebla, alpha = 0.05)
graf_monitor(monitor_pue)
```


```{r, warning = FALSE}
monitor_chi <- monitor_bayes(chilchotla, alpha = 0.05)
graf_monitor(monitor_chi)
```


# Métodos de monitoreo: Farrington

Consideramos ahora el método de Farrington (mejorado), que utiliza un modelo lineal generalizado
Poisson:

1. Supongamos que los valores de referencia son $y_t$
2. Se ajusta un modelo Poisson sobredisperso a los datos de referencia,
con
$$E(y_t) = \mu_t, Var(y_t) = \phi \mu_t,$$
donde $\phi$ es el parámetro de sobredispersión, y donde
$$\log(\mu_k) = \alpha + \beta t$$ 
sirve para modelar tendencia.

3. Se calculan pesos para los datos, reduciendo el peso de *outliers* según
la distribución obtenida de los datos de referencia.

4. Se reajusta el modelo con los pesos calculados en el paso anterior

5. Para el paso de detección, usamos el método de Noufaily (2012) (ver referencia
de paquete), donde la distribución de referencia para el nuevo valor $y_{t_0}$
es
$$y_{t_0}\sim NB(\mu_{t_0}, \eta)$$ 
donde $\eta= \frac{\mu_{t_0}}{\phi - 1}$.

Notas: 

- Este enfoque ignora la incertidumbre en la estimación de los parámetros
$\mu_{t_0}$ y $\phi$.
- Para declarar una anomalía, se requieren también al menos 5 casos en los últimos 3 meses (incluyendo el mes que se está evaluando).

6. Utilizamos 4 meses alrededor de del valor que queremos predecir, considerando
dos años atrás (para un total de 2 + 2(4) + 1 = 11 datos de referencia).

### Ejemplos: método de Farrington mejorado


```{r, warning = FALSE}
monitor_huau <- monitor_farrington(huauchinango, alpha=0.05, periods = 10)
graf_monitor(monitor_huau)
```


```{r}
monitor_huau$data %>%  tail
```



```{r}
monitor_pue <- monitor_farrington(puebla, alpha=0.05, periods = 10)
graf_monitor(monitor_pue)
```

```{r, warning = FALSE}
monitor_puebla <- monitor_farrington(puebla, periods = 10)
```

Nótese que las bandas en la estimación de Farrington puede colapsarse para municipios
con niveles bajos de homicidios:

```{r, warning = FALSE}
monitor_chi <- monitor_farrington(chilchotla, alpha = 0.05, periods = 10)
graf_monitor(monitor_chi)
```



# Otros ejemplos

En Sinaloa, por ejemplo, no observamos ninguna alarma reciente. Aún
cuando algunas tasas de homicidio son muy altas en todo el periodo
de referencia/evaluación, no se detectan brotes recientes:

```{r}
#sinaloa_edo <- filter(homicidios, state == "SINALOA")
sinaloa_edo <- readRDS("data/sinaloa.rds")
sinaloa_edo %>% group_by(municipio) %>% summarise(count = sum(count)) %>% 
    arrange(desc(count)) 
```

```{r, warning = FALSE ,fig.keep=FALSE}
dat_sinaloa <- sinaloa_edo %>% split(.$municipio) 
monitores_sinaloa <- 
    lapply(dat_sinaloa, function(df){
        monitor_mun <- monitor_farrington(df, alpha = 0.02, periods = 5)
        g <- graf_monitor(monitor_mun)
        g
    })
```

```{r, fig.width = 6, fig.height = 10, warning = FALSE}
library(gridExtra)
marrangeGrob(monitores_sinaloa, nrow = 6, ncol = 3)
```

En los siguientes ejemplos sólo mostramos los municipios con detección
de anomalías:

```{r, warning = FALSE}
mex_edo <- filter(homicidios, state == "MICHOACÁN")
#sinaloa_edo <- readRDS("data/sinaloa.rds")
mex_edo %>% group_by(municipio) %>% summarise(count = sum(count)) %>% 
    arrange(desc(count)) 
```

```{r, warning = FALSE, fig.width = 6, fig.height = 10}
dat_mex <- mex_edo %>% split(.$municipio) 
monitores_mex <- 
    lapply(dat_mex, function(df){
        monitor_mun <- monitor_farrington(df, alpha = 0.02, periods = 5)
        g <- graf_monitor(monitor_mun)
        list(graf = g, monitor = monitor_mun)
    })
```

```{r}
tiene_alerta <- function(monitor){
    any(monitor$monitor$data$alerta == 1, na.rm = TRUE)
}
monitores_alarma <- keep(monitores_mex, tiene_alerta)
```

```{r, warning = FALSE, fig.width = 10, fig.height = 3}
graficas <- monitores_alarma %>% map(~.$graf)
marrangeGrob(graficas, nrow = 1, ncol = 4)
```



```{r, warning = FALSE, fig.width = 10, fig.height = 3}
mex_edo <- filter(homicidios, state == "VERACRUZ")
#sinaloa_edo <- readRDS("data/sinaloa.rds")
mex_edo %>% group_by(municipio) %>% summarise(count = sum(count)) %>% 
    arrange(desc(count)) 
```

```{r, warning = FALSE, fig.width = 10, fig.height = 3}
dat_mex <- mex_edo %>% split(.$municipio) 
monitores_mex <- 
    lapply(dat_mex, function(df){
        monitor_mun <- monitor_farrington(df, alpha = 0.02, periods = 5)
        g <- graf_monitor(monitor_mun)
        list(graf = g, monitor = monitor_mun)
    })
```

```{r}
monitores_alarma <- keep(monitores_mex, tiene_alerta)
```

```{r, warning = FALSE, fig.width = 10, fig.height = 3}
graficas <- monitores_alarma %>% map(~.$graf)
marrangeGrob(graficas, nrow = 1, ncol = 4)
```


# Propuesta: Método mixto

Proponemos un método mixto para construir rango y alertas 
para todos los municipios:

- Aplicamos primero el método Farrington flexible. 
Si el algoritmo converge, y hay suficientes datos (dos años atrás), utilizamos su salida.
- En otro caso, utilizamos el método bayesiano simple
    aplicado a los últimos 6 meses de datos.
    
Si hay suficientes datos hacia atrás, Farrington puede fallar
cuando observamos conteos muy bajos (proporción alta de ceros).    

Típicamente, estos métodos se evalúan con etiquetado de brotes según expertos
en epidemiología ([@Yang2018]). En nuestro caso, consideramos propiedades básicas
de la estimación y comportamiento con los datos observados, pero
 los métodos deberán ser evaluados por expertos en el tema que puedan etiquetar
 cuáles saltos indican brotes de violencia o no. 

## Método mixto para todos los municipios.

Al aplicar para detección del último mes con los datos actuales
obtenemos la siguiente proporción de uso de Farrington vs Bayesiano simple:

```{r}
dat_nal <- homicidios %>% split(list(.$municipio, .$state), drop = TRUE) 
length(dat_nal)

monitores_nal <- 
    lapply(dat_nal, function(df){
        # farrington por default, a menos que haya menos de 2 años de datos
        # o no converja.
        monitor_mun <- monitor(df, alpha = 0.05, periods = 1)
        #g <- graf_monitor(monitor_mun)
        #list(graf = g, monitor = monitor_mun)
        monitor_mun
    })
tipos <- sapply(monitores_nal, function(monitor){ monitor$tipo })
table(tipos)
```

Y en la siguiente tabla mostramos que cuando hay menos de un año de datos,
se utiliza siempre bayes simple. El de Farrington se utiliza en la mayor
parte de los casos cuando hay más de un año de datos, excepto en algunos
casos de conteo bajo donde no converge apropiadamente.

```{r}
conteos_bajo <- sapply(monitores_nal, function(monitor){ sum(tail(monitor$data$count,6)) < 5})
menos_1_año <- sapply(monitores_nal, function(monitor){ length(monitor$data$count) < 24})
data_frame(conteo_bajo = conteos_bajo, menos_1_año = menos_1_año, tipo = tipos) %>% 
    group_by(menos_1_año, conteo_bajo, tipo) %>% tally() %>% spread(tipo, n)
```

El número de alertas generadas para este último mes, los municipios afectados:


```{r}
alertas <- sapply(monitores_nal, function(monitor){ 
    any(monitor$data$alerta, na.rm = TRUE) }
    )
table(alertas)
alertas_mun <- which(alertas)
alertas_mun
```

Finalmente, mostramos los datos detectados para todos los municipios
con alerta:

```{r, warning = FALSE, fig.width=8, fig.height=20}
monitores_alerta <- monitores_nal[alertas_mun]
graficas <- monitores_alerta %>% map(graf_monitor) 
marrangeGrob(graficas, nrow = 8, ncol = 4)
```


# References


